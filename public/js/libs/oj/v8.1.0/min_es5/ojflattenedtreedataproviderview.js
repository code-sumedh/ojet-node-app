/**
 * @license
 * Copyright (c) 2014, 2020, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 * @ignore
 */
"use strict";define(["ojs/ojcore","jquery","ojs/ojset","ojs/ojeventtarget","ojs/ojdataprovider","ojs/ojkeyset","ojs/ojobservable","ojs/ojmap"],function(t,e,i,a,r,n,s,h){function u(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function d(t,e,i){return e&&o(t.prototype,e),i&&o(t,i),t}var c=function(){function e(t,i){u(this,e),this.dataProvider=t,this.options=i,this._DATAPROVIDER="dataprovider",this._EXPANDED="expanded",this._KEY="key",this._PARENTKEY="parentKey",this._INDEXFROMPARENT="indexFromParent",this._TREEDEPTH="treeDepth",this._ISLEAF="isLeaf",this._KEYS="keys",this._OFFSET="offset",this._SIZE="size",this._DONE="done",this._VALUE="value",this._DATA="data",this._REFRESH="refresh",this._MUTATE="mutate",this._SORTCRITERIA="sortCriteria",this._FILTERCRITERION="filterCriterion",this._ATTRIBUTES="attributes",this._METADATA="metadata",this._RESULTS="results",this._FETCHPARAMETERS="fetchParameters",this._CONTAINSPARAMETERS="containsParameters",this._CONTAINSKEYS="containsKeys",this._FETCHBYKEYS="fetchByKeys",this._FETCHBYOFFSET="fetchByOffset",this._AFTERKEYS="afterKeys",this._ADDBEFOREKEYS="addBeforeKeys",this._ADD="add",this._REMOVE="remove",this._UPDATE="update",this._INDEXES="indexes",this._ADDEVENTLISTENER="addEventListener",this.AsyncIterable=function(){return function t(e,i){u(this,t),this._parent=e,this._asyncIterator=i,this[Symbol.asyncIterator]=function(){return this._asyncIterator}}}(),this.AsyncIterator=function(){function t(e,i,a){u(this,t),this._parent=e,this._nextFunc=i,this._params=a}return d(t,[{key:"next",value:function(){var t=this._nextFunc(this._params);return Promise.resolve(t)}}]),t}(),this.AsyncIteratorYieldResult=function(){return function t(e,i){u(this,t),this._parent=e,this.value=i,this[e._VALUE]=i,this[e._DONE]=!1}}(),this.AsyncIteratorReturnResult=function(){return function t(e,i){u(this,t),this._parent=e,this.value=i,this[e._VALUE]=i,this[e._DONE]=!0}}(),this.Item=function(){return function t(e,i,a){u(this,t),this._parent=e,this.metadata=i,this.data=a,this[e._METADATA]=i,this[e._DATA]=a}}(),this.FlattenedTreeItemMetadata=function(){return function t(e,i,a,r,n,s){u(this,t),this._parent=e,this.key=i,this.parentKey=a,this.indexFromParent=r,this.treeDepth=n,this.isLeaf=s,this[e._KEY]=i,this[e._PARENTKEY]=a,this[e._INDEXFROMPARENT]=r,this[e._TREEDEPTH]=n,this[e._ISLEAF]=s}}(),this.FetchListParameters=function(){return function t(e,i,a,r){u(this,t),this._parent=e,this.size=i,this.sortCriteria=a,this.filterCriterion=r,this[e._SIZE]=i,this[e._SORTCRITERIA]=a,this[e._FILTERCRITERION]=r}}(),this.FetchListResult=function(){return function t(e,i,a,r){u(this,t),this._parent=e,this.fetchParameters=i,this.data=a,this.metadata=r,this[e._FETCHPARAMETERS]=i,this[e._DATA]=a,this[e._METADATA]=r}}(),this.FetchByOffsetParameters=function(){return function t(e,i,a,r,n,s){u(this,t),this._parent=e,this.offset=i,this.size=a,this.sortCriteria=r,this.filterCriterion=n,this.attributes=s,this[e._OFFSET]=i,this[e._SIZE]=a,this[e._SORTCRITERIA]=r,this[e._FILTERCRITERION]=n,this[e._ATTRIBUTES]=s}}(),this.FetchByOffsetResults=function(){return function t(e,i,a,r){u(this,t),this._parent=e,this.fetchParameters=i,this.results=a,this.done=r,this[e._FETCHPARAMETERS]=i,this[e._RESULTS]=a,this[e._DONE]=r}}(),this.FetchByKeysResults=function(){return function t(e,i,a){u(this,t),this._parent=e,this.fetchParameters=i,this.results=a,this[e._FETCHPARAMETERS]=i,this[e._RESULTS]=a}}(),this.ContainsKeysResults=function(){return function t(e,i,a){u(this,t),this._parent=e,this.containsParameters=i,this.results=a,this[e._CONTAINSPARAMETERS]=i,this[e._RESULTS]=a}}(),this.DataProviderMutationEventDetail=function(){return function t(e,i,a,r){u(this,t),this._parent=e,this.add=i,this.remove=a,this.update=r,this[e._ADD]=i,this[e._REMOVE]=a,this[e._UPDATE]=r}}(),this.DataProviderOperationEventDetail=function(){return function t(e,i,a,r,n){u(this,t),this._parent=e,this.keys=i,this.metadata=a,this.data=r,this.indexes=n,this[e._KEYS]=i,this[e._METADATA]=a,this[e._DATA]=r,this[e._INDEXES]=n}}(),this.DataProviderAddOperationEventDetail=function(){return function t(e,i,a,r,n,s,h){u(this,t),this._parent=e,this.keys=i,this.afterKeys=a,this.addBeforeKeys=r,this.metadata=n,this.data=s,this.indexes=h,this[e._KEYS]=i,this[e._AFTERKEYS]=a,this[e._ADDBEFOREKEYS]=r,this[e._METADATA]=n,this[e._DATA]=s,this[e._INDEXES]=h}}();null==this.options&&(this.options={}),this.options.expanded||(this.options.expanded=new n.ExpandedKeySet([])),this._expandedObservable=new s.BehaviorSubject(this._getExpandedObservableValue(this.options.expanded,Promise.resolve())),this.dataProvider.addEventListener("mutate",this._handleUndelryingMutation.bind(this)),this.dataProvider.addEventListener("refresh",this._handleUndelryingRefresh.bind(this)),this._cache=[],this._iterators=new h,this._done=!1}return d(e,[{key:"_handleUndelryingMutation",value:function(e){var i=this,a=null,r=null,n=null,s=e.detail.add;if(s&&s.data&&s.data.length){var h=[],u=[],o=[],d=[],c=[],l=new Set,f=new Set;s.parentKeys.forEach(function(t,e){if(null===t||i._isExpanded(t)&&i._getItemByKey(t)){var a;if(null!=s.addBeforeKeys)a=i._getItemIndexByKey(s.addBeforeKeys[e])-1;else if(null!=s.indexes){var r=i._getItemIndexByKey(t);a=-1===r?s.indexes[e]:r+s.indexes[e]}else a=i._getItemIndexByKey(i._getLastItemByParentKey(t).metadata.key)+1;var n=i._updateItemMetadata(new i.Item(i,s.metadata[e],s.data[e]),t,s.indexes[e]);i._spliceItemToCache(n,a),u.push(n.data),h.push(n.metadata),o.push(a),d.push(s.addBeforeKeys[e]),c.push(t),l.add(s.addBeforeKeys[e]),f.add(s.metadata[e].key),i._incrementIteratorOffset()}}),a=new i.DataProviderAddOperationEventDetail(i,f,l,d,h,u,o)}var _=e.detail.remove;if(_&&_.data&&_.data.length){var y=_.metadata.map(function(t){return t.key}),E=[],v=[],m=[],p=new Set;y.forEach(function(t){var e=i._getLocalDescendentCount(t)+1,a=i._getItemIndexByKey(t);i._cache.splice(a,e).forEach(function(t,e){p.add(t.metadata.key),E.push(t.metadata),v.push(t.data),m.push(a+e),i._decrementIteratorOffset(a)})}),r=new i.DataProviderOperationEventDetail(i,p,E,v,m)}var I=e.detail.update;if(I&&I.data&&I.data.length){var T=[],R=[],O=[],A=new Set;I.metadata.forEach(function(t,e){var a=i._getItemByKey(t.key);if(null!=a){var r=i._getItemIndexByKey(t.key),n=I.data[e],s=new i.FlattenedTreeItemMetadata(i,a.metadata.key,a.metadata.parentKey,a.metadata.indexFromParent,a.metadata.treeDepth,null===i.getChildDataProvider(a.metadata.key));i._cache.splice(r,1,new i.Item(i,s,n)),A.add(a.metadata.key),T.push(a.metadata),R.push(a.data),O.push(r)}}),n=new i.DataProviderOperationEventDetail(i,A,T,R,O)}var S=new i.DataProviderMutationEventDetail(i,a,r,n);i.dispatchEvent(new t.DataProviderMutationEvent(S))}},{key:"_handleUndelryingRefresh",value:function(){this._clearCache(),this.dispatchEvent(new t.DataProviderRefreshEvent)}},{key:"_getExpandedObservableValue",value:function(t,e){return{value:t,completionPromise:e}}},{key:"getChildDataProvider",value:function(t,e){return this.dataProvider.getChildDataProvider(t,e)}},{key:"containsKeys",value:function(t){return this.dataProvider.containsKeys(t)}},{key:"fetchByKeys",value:function(t){var e=this;return this.dataProvider.fetchByKeys(t).then(function(t){var i=new h;return t.results.forEach(function(t,a){var r=e._getItemByKey(a);r?i.set(a,r):i.set(a,t)}),new e.FetchByKeysResults(e,t.fetchParameters,i)})}},{key:"fetchByOffset",value:function(t){var e=this,i=null!=t?t[this._SIZE]:-1,a=null!=t?t[this._SORTCRITERIA]:null,r=null!=t&&t[this._OFFSET]>0?t[this._OFFSET]:0,n=null!=t?t[this._FILTERCRITERION]:null,s=null!=t?t[this._ATTRIBUTES]:null;if(t=new e.FetchByOffsetParameters(e,r,i,a,n,s),e._isSameCriteria(a,n)){if(e._checkCacheByOffset(t))return new Promise(function(i){i(e._getFetchByOffsetResultsFromCache(t))})}else e._clearCache(),e._currentSortCriteria=a,e._currentFilterCriteria=n;return e._fetchByOffset(t)}},{key:"fetchFirst",value:function(t){var e=this,i=null!=t?t[this._SIZE]:-1,a=null!=t?t[this._SORTCRITERIA]:null,r=null!=t?t[this._FILTERCRITERION]:null,n=null!=t?t[this._ATTRIBUTES]:null;e._isSameCriteria(a,r)||(e._currentSortCriteria=a,e._currentFilterCriteria=r,e._clearCache());var s=new e.AsyncIterable(e,new e.AsyncIterator(e,function(){var t=e._iterators.get(s),h=new e.FetchByOffsetParameters(e,t,i,a,r,n);return e.fetchByOffset(h).then(function(i){var a=i.results,r=a.map(function(t){return t[e._DATA]}),n=a.map(function(t){return t[e._METADATA]}),u=0===r.length||i[e._DONE];return e._iterators.set(s,t+n.length),u?Promise.resolve(new e.AsyncIteratorReturnResult(e,new e.FetchListResult(e,h,r,n))):Promise.resolve(new e.AsyncIteratorYieldResult(e,new e.FetchListResult(e,h,r,n)))})},t));return e._iterators.set(s,0),s}},{key:"getCapability",value:function(t){return this.dataProvider.getCapability(t)}},{key:"getTotalSize",value:function(){return Promise.resolve(-1)}},{key:"isEmpty",value:function(){return this.dataProvider.isEmpty()}},{key:"_isSameCriteria",value:function(t,e){if(t){if(!this._currentSortCriteria||t[0].attribute!=this._currentSortCriteria[0].attribute||t[0].direction!=this._currentSortCriteria[0].direction)return!1}else if(this._currentSortCriteria)return!1;if(e){if(!this._currentFilterCriteria||e[0].op!=this._currentFilterCriteria[0].op||e[0].filter!=this._currentFilterCriteria[0].filter)return!1}else if(this._currentFilterCriteria)return!1;return!0}},{key:"_checkCacheByOffset",value:function(t){return-1===t[this._SIZE]&&!0===this._done||this._cache.length>=t[this._OFFSET]+t[this._SIZE]&&-1!==t[this._SIZE]}},{key:"_getFetchByOffsetResultsFromCache",value:function(t){var e=this._cache.slice(t[this._OFFSET],-1===t[this._SIZE]?void 0:t[this._OFFSET]+t[this._SIZE]);return new this.FetchByOffsetResults(this,t,e,!1)}},{key:"_clearCache",value:function(){this._cache=[]}},{key:"_fetchByOffset",value:function(t){if(0===this._cache.length){var e=-1===t[this._SIZE]?-1:t[this._OFFSET]+t[this._SIZE],i=new this.FetchByOffsetParameters(this,0,e,t[this._SORTCRITERIA],t[this._FILTERCRITERION],t[this._ATTRIBUTES]);return this._fetchChildrenByOffsetFromDataProvider(i,this.dataProvider,null,t)}var a=this._getLastEntry(),r=a.metadata.key,n=0;!a.metadata.isLeaf&&this._isExpanded(r)||(r=a.metadata.parentKey,n=a.metadata.indexFromParent+1);var s=null===r?this.dataProvider:this.getChildDataProvider(r),h=this._getRemainingSize(t),u=new this.FetchByOffsetParameters(this,n,h,t[this._SORTCRITERIA],t[this._FILTERCRITERION],t[this._ATTRIBUTES]);return this._fetchChildrenByOffsetFromAncestors(u,s,r,t)}},{key:"_fetchChildrenByOffsetFromAncestors",value:function(t,e,i,a){var r=this;return r._fetchChildrenByOffsetFromDataProvider(t,e,i,a).then(function e(i,n){n.results;if(r._checkCacheByOffset(a)||n[r._DONE]||null===i)return Promise.resolve();var s=r._getItemByKey(i),h=s.metadata.parentKey,u=s.metadata.indexFromParent,o=null===h?r.dataProvider:r.getChildDataProvider(h),d=new r.FetchByOffsetParameters(r,u+1,r._getRemainingSize(a),t[r._SORTCRITERIA],t[r._FILTERCRITERION],t[r._ATTRIBUTES]);return r._fetchChildrenByOffsetFromDataProvider(d,o,h,a).then(e.bind(r,h))}.bind(r,i)).then(r._getFetchByOffsetResultsFromCache.bind(r,a))}},{key:"_fetchChildrenByOffsetFromDataProvider",value:function(t,e,i,a){var r=this;return e.fetchByOffset(t).then(function e(n){var s=n.results;if(0===s.length||r._checkCacheByOffset(a))return Promise.resolve();var h=s.shift(),u=r._updateItemMetadata(h,i);if(r._pushItemToCache(u,i),r._isExpanded(u.metadata.key)){var o=r.getChildDataProvider(u.metadata.key);if(null!=o){var d=new r.FetchByOffsetParameters(r,0,r._getRemainingSize(a),t[r._SORTCRITERIA],t[r._FILTERCRITERION],t[r._ATTRIBUTES]);return r._fetchChildrenByOffsetFromDataProvider(d,o,u.metadata.key,a).then(e.bind(r,new r.FetchByOffsetResults(r,t,s,!1)))}}return e(new r.FetchByOffsetResults(r,t,s,!1))}).then(r._getFetchByOffsetResultsFromCache.bind(r,a))}},{key:"_sequence",value:function(t,e){return t.reduce(function(t,i){return t.then(function(){return e(i)})},Promise.resolve())}},{key:"_getRemainingSize",value:function(t){return-1===t[this._SIZE]?-1:t[this._SIZE]+t[this._OFFSET]-this._cache.length}},{key:"_getExpandedKeysFromResults",value:function(t){var e=this;return t.map(function(t){return t.metadata.key}).filter(function(t){return e._isExpanded(t)})}},{key:"_isExpanded",value:function(t){return this.options[this._EXPANDED].has(t)}},{key:"setExpanded",value:function(e){var i=this,a=i.createOptimizedKeySet(),r=i.createOptimizedKeySet();i._oldExpanded=i.options.expanded,i.options.expanded=e;var n=i._oldExpanded,s=i.options.expanded;if(s.isAddAll()||n.isAddAll()){if(!s.isAddAll()||!n.isAddAll())return i._clearCache(),i.dispatchEvent(new t.DataProviderRefreshEvent),void i.getExpandedObservable().next(i._getExpandedObservableValue(this.options.expanded,Promise.resolve()));var h=s.deletedValues(),u=n.deletedValues();h.forEach(function(t){n.has(t)&&r.add(t)}),u.forEach(function(t){s.has(t)&&a.add(t)})}else{var o=s.values(),d=n.values();o.forEach(function(t){n.has(t)||a.add(t)}),d.forEach(function(t){s.has(t)||r.add(t)})}var c=i._expand(a),l=i._collapse(r),f=new Promise(function(e){c.then(function(a){var r=new i.DataProviderMutationEventDetail(i,a,l,null);i.dispatchEvent(new t.DataProviderMutationEvent(r)),e()})});i.getExpandedObservable().next(i._getExpandedObservableValue(this.options.expanded,f))}},{key:"getExpandedObservable",value:function(){return this._expandedObservable}},{key:"_isExpandAll",value:function(){return this.options[this._EXPANDED].isAddAll()}},{key:"_pushItemToCache",value:function(t,e){var i=this._getLastItemByParentKey(e),a=null==i?this._getItemIndexByKey(e):this._getItemIndexByKey(i.metadata.key)+this._getLocalDescendentCount(i.metadata.key);this._cache.splice(a+1,0,t)}},{key:"_spliceItemToCache",value:function(t,e){this._cache.splice(e+1,0,t)}},{key:"_updateItemMetadata",value:function(t,e,i){var a=0,r=this._getLastItemByParentKey(e),n=null==r?0:r.metadata[this._INDEXFROMPARENT]+1;(null!=i&&(n=i),null!=e)&&(a=this._getItemByKey(e).metadata.treeDepth+1);return new this.Item(this,new this.FlattenedTreeItemMetadata(this,t.metadata.key,e,n,a,null===this.getChildDataProvider(t.metadata.key)),t.data)}},{key:"_getItemByKey",value:function(t){var e=null;return this._cache.some(function(i){if(i.metadata.key===t)return e=i,!0}),e}},{key:"_getItemIndexByKey",value:function(t){var e=-1;return this._cache.some(function(i,a){if(i.metadata.key===t)return e=a,!0}),e}},{key:"_getLastEntry",value:function(){return this._cache[this._getLastIndex()]}},{key:"_getEntry",value:function(t){return this._cache[t]}},{key:"_getLastItemByParentKey",value:function(t){var e=null;return this._cache.slice().reverse().some(function(i){if(i.metadata.parentKey===t)return e=i,!0}),e}},{key:"_getLastIndex",value:function(){return this._cache.length-1}},{key:"_getLocalDescendentCount",value:function(t){var e=this._getItemByKey(t),i=0;if(null!=e)for(var a=this._getItemIndexByKey(t),r=e.metadata.treeDepth,n=this._getLastIndex(),s=a+1;s<=n;s++){if(!(this._getEntry(s).metadata.treeDepth>r))return i;i+=1}return i}},{key:"_expand",value:function(t){var e=[],i=this;return t.forEach(function(t){var a=new i.FetchByOffsetParameters(i,0,-1,i._currentSortCriteria,i._currentFilterCriteria,null),r=i.getChildDataProvider(t);e.push(i._fetchChildrenByOffsetFromDataProvider(a,r,t,a))}),Promise.all(e).then(function(){var e=i.createOptimizedKeySet(),a=i.createOptimizedKeySet(),r=[],n=[],s=[];return t.forEach(function(t){var h=i._getLocalDescendentCount(t);if(h>0){var u=i._getItemIndexByKey(t)+1,o=null;i._cache.slice(u,u+h).forEach(function(t,h){e.add(t.metadata.key),a.add(o),r.push(t.metadata),n.push(t.data),s.push(u+h),o=t.metadata.key,i._incrementIteratorOffset()})}}),new i.DataProviderAddOperationEventDetail(i,e,a,[],r,n,s)})}},{key:"_collapse",value:function(t){var e=this,i=[],a=[],r=[],n=e.createOptimizedKeySet();return t.forEach(function(t){var s=e._getLocalDescendentCount(t);if(s>0){var h=e._getItemIndexByKey(t);e._cache.splice(h+1,s).forEach(function(t,s){n.add(t.metadata.key),i.push(t.metadata),a.push(t.data),r.push(h+s+1),e._decrementIteratorOffset(h+1)})}}),new e.DataProviderOperationEventDetail(e,n,i,a,r)}},{key:"_decrementIteratorOffset",value:function(t){var e=this;e._iterators.forEach(function(i,a){t<i&&e._iterators.set(a,i-1)})}},{key:"_incrementIteratorOffset",value:function(){var t=this;t._iterators.forEach(function(e,i){t._iterators.set(i,e+1)})}},{key:"createOptimizedKeySet",value:function(t){return this.dataProvider.createOptimizedKeySet?this.dataProvider.createOptimizedKeySet(t):new i(t)}},{key:"createOptimizedKeyMap",value:function(t){if(this.dataProvider.createOptimizedKeyMap)return this.dataProvider.createOptimizedKeyMap(t);if(t){var e=new h;return t.forEach(function(t,i){e.set(i,t)}),e}return new h}}]),e}();
/**
 * @preserve Copyright 2013 jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 */
return t.FlattenedTreeDataProviderView=c,t.FlattenedTreeDataProviderView=c,t.EventTargetMixin.applyMixin(c),c});