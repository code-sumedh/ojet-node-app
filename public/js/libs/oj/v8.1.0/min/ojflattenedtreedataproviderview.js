/**
 * @license
 * Copyright (c) 2014, 2020, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 * @ignore
 */
"use strict";define(["ojs/ojcore","jquery","ojs/ojset","ojs/ojeventtarget","ojs/ojdataprovider","ojs/ojkeyset","ojs/ojobservable","ojs/ojmap"],function(e,t,a,r,i,s,n,h){class d{constructor(e,t){this.dataProvider=e,this.options=t,this._DATAPROVIDER="dataprovider",this._EXPANDED="expanded",this._KEY="key",this._PARENTKEY="parentKey",this._INDEXFROMPARENT="indexFromParent",this._TREEDEPTH="treeDepth",this._ISLEAF="isLeaf",this._KEYS="keys",this._OFFSET="offset",this._SIZE="size",this._DONE="done",this._VALUE="value",this._DATA="data",this._REFRESH="refresh",this._MUTATE="mutate",this._SORTCRITERIA="sortCriteria",this._FILTERCRITERION="filterCriterion",this._ATTRIBUTES="attributes",this._METADATA="metadata",this._RESULTS="results",this._FETCHPARAMETERS="fetchParameters",this._CONTAINSPARAMETERS="containsParameters",this._CONTAINSKEYS="containsKeys",this._FETCHBYKEYS="fetchByKeys",this._FETCHBYOFFSET="fetchByOffset",this._AFTERKEYS="afterKeys",this._ADDBEFOREKEYS="addBeforeKeys",this._ADD="add",this._REMOVE="remove",this._UPDATE="update",this._INDEXES="indexes",this._ADDEVENTLISTENER="addEventListener",this.AsyncIterable=class{constructor(e,t){this._parent=e,this._asyncIterator=t,this[Symbol.asyncIterator]=function(){return this._asyncIterator}}},this.AsyncIterator=class{constructor(e,t,a){this._parent=e,this._nextFunc=t,this._params=a}next(){let e=this._nextFunc(this._params);return Promise.resolve(e)}},this.AsyncIteratorYieldResult=class{constructor(e,t){this._parent=e,this.value=t,this[e._VALUE]=t,this[e._DONE]=!1}},this.AsyncIteratorReturnResult=class{constructor(e,t){this._parent=e,this.value=t,this[e._VALUE]=t,this[e._DONE]=!0}},this.Item=class{constructor(e,t,a){this._parent=e,this.metadata=t,this.data=a,this[e._METADATA]=t,this[e._DATA]=a}},this.FlattenedTreeItemMetadata=class{constructor(e,t,a,r,i,s){this._parent=e,this.key=t,this.parentKey=a,this.indexFromParent=r,this.treeDepth=i,this.isLeaf=s,this[e._KEY]=t,this[e._PARENTKEY]=a,this[e._INDEXFROMPARENT]=r,this[e._TREEDEPTH]=i,this[e._ISLEAF]=s}},this.FetchListParameters=class{constructor(e,t,a,r){this._parent=e,this.size=t,this.sortCriteria=a,this.filterCriterion=r,this[e._SIZE]=t,this[e._SORTCRITERIA]=a,this[e._FILTERCRITERION]=r}},this.FetchListResult=class{constructor(e,t,a,r){this._parent=e,this.fetchParameters=t,this.data=a,this.metadata=r,this[e._FETCHPARAMETERS]=t,this[e._DATA]=a,this[e._METADATA]=r}},this.FetchByOffsetParameters=class{constructor(e,t,a,r,i,s){this._parent=e,this.offset=t,this.size=a,this.sortCriteria=r,this.filterCriterion=i,this.attributes=s,this[e._OFFSET]=t,this[e._SIZE]=a,this[e._SORTCRITERIA]=r,this[e._FILTERCRITERION]=i,this[e._ATTRIBUTES]=s}},this.FetchByOffsetResults=class{constructor(e,t,a,r){this._parent=e,this.fetchParameters=t,this.results=a,this.done=r,this[e._FETCHPARAMETERS]=t,this[e._RESULTS]=a,this[e._DONE]=r}},this.FetchByKeysResults=class{constructor(e,t,a){this._parent=e,this.fetchParameters=t,this.results=a,this[e._FETCHPARAMETERS]=t,this[e._RESULTS]=a}},this.ContainsKeysResults=class{constructor(e,t,a){this._parent=e,this.containsParameters=t,this.results=a,this[e._CONTAINSPARAMETERS]=t,this[e._RESULTS]=a}},this.DataProviderMutationEventDetail=class{constructor(e,t,a,r){this._parent=e,this.add=t,this.remove=a,this.update=r,this[e._ADD]=t,this[e._REMOVE]=a,this[e._UPDATE]=r}},this.DataProviderOperationEventDetail=class{constructor(e,t,a,r,i){this._parent=e,this.keys=t,this.metadata=a,this.data=r,this.indexes=i,this[e._KEYS]=t,this[e._METADATA]=a,this[e._DATA]=r,this[e._INDEXES]=i}},this.DataProviderAddOperationEventDetail=class{constructor(e,t,a,r,i,s,n){this._parent=e,this.keys=t,this.afterKeys=a,this.addBeforeKeys=r,this.metadata=i,this.data=s,this.indexes=n,this[e._KEYS]=t,this[e._AFTERKEYS]=a,this[e._ADDBEFOREKEYS]=r,this[e._METADATA]=i,this[e._DATA]=s,this[e._INDEXES]=n}};let a=this;null==a.options&&(a.options={}),a.options.expanded||(a.options.expanded=new s.ExpandedKeySet([])),a._expandedObservable=new n.BehaviorSubject(a._getExpandedObservableValue(a.options.expanded,Promise.resolve())),a.dataProvider.addEventListener("mutate",a._handleUndelryingMutation.bind(a)),a.dataProvider.addEventListener("refresh",a._handleUndelryingRefresh.bind(a)),a._cache=[],a._iterators=new h,a._done=!1}_handleUndelryingMutation(t){let a=this,r=null,i=null,s=null,n=t.detail.add;if(n&&n.data&&n.data.length){let e=[],t=[],i=[],s=[],h=[],d=new Set,l=new Set;n.parentKeys.forEach(function(r,o){if(null===r||a._isExpanded(r)&&a._getItemByKey(r)){let c;if(null!=n.addBeforeKeys){c=a._getItemIndexByKey(n.addBeforeKeys[o])-1}else if(null!=n.indexes){let e=a._getItemIndexByKey(r);c=-1===e?n.indexes[o]:e+n.indexes[o]}else c=a._getItemIndexByKey(a._getLastItemByParentKey(r).metadata.key)+1;let _=a._updateItemMetadata(new a.Item(a,n.metadata[o],n.data[o]),r,n.indexes[o]);a._spliceItemToCache(_,c),t.push(_.data),e.push(_.metadata),i.push(c),s.push(n.addBeforeKeys[o]),h.push(r),d.add(n.addBeforeKeys[o]),l.add(n.metadata[o].key),a._incrementIteratorOffset()}}),r=new a.DataProviderAddOperationEventDetail(a,l,d,s,e,t,i)}let h=t.detail.remove;if(h&&h.data&&h.data.length){let e=h.metadata.map(function(e){return e.key}),t=[],r=[],s=[],n=new Set;e.forEach(function(e){let i=a._getLocalDescendentCount(e)+1,h=a._getItemIndexByKey(e);a._cache.splice(h,i).forEach(function(e,i){n.add(e.metadata.key),t.push(e.metadata),r.push(e.data),s.push(h+i),a._decrementIteratorOffset(h)})}),i=new a.DataProviderOperationEventDetail(a,n,t,r,s)}let d=t.detail.update;if(d&&d.data&&d.data.length){let e=[],t=[],r=[],i=new Set;d.metadata.forEach(function(s,n){let h=a._getItemByKey(s.key);if(null!=h){let c=a._getItemIndexByKey(s.key);var l=d.data[n],o=new a.FlattenedTreeItemMetadata(a,h.metadata.key,h.metadata.parentKey,h.metadata.indexFromParent,h.metadata.treeDepth,null===a.getChildDataProvider(h.metadata.key));a._cache.splice(c,1,new a.Item(a,o,l)),i.add(h.metadata.key),e.push(h.metadata),t.push(h.data),r.push(c)}}),s=new a.DataProviderOperationEventDetail(a,i,e,t,r)}let l=new a.DataProviderMutationEventDetail(a,r,i,s);a.dispatchEvent(new e.DataProviderMutationEvent(l))}_handleUndelryingRefresh(){this._clearCache(),this.dispatchEvent(new e.DataProviderRefreshEvent)}_getExpandedObservableValue(e,t){return{value:e,completionPromise:t}}getChildDataProvider(e,t){return this.dataProvider.getChildDataProvider(e,t)}containsKeys(e){return this.dataProvider.containsKeys(e)}fetchByKeys(e){var t=this;return this.dataProvider.fetchByKeys(e).then(function(e){let a=new h;return e.results.forEach(function(e,r){let i=t._getItemByKey(r);i?a.set(r,i):a.set(r,e)}),new t.FetchByKeysResults(t,e.fetchParameters,a)})}fetchByOffset(e){let t=this,a=null!=e?e[this._SIZE]:-1,r=null!=e?e[this._SORTCRITERIA]:null,i=null!=e&&e[this._OFFSET]>0?e[this._OFFSET]:0,s=null!=e?e[this._FILTERCRITERION]:null,n=null!=e?e[this._ATTRIBUTES]:null;if(e=new t.FetchByOffsetParameters(t,i,a,r,s,n),t._isSameCriteria(r,s)){if(t._checkCacheByOffset(e))return new Promise(function(a){a(t._getFetchByOffsetResultsFromCache(e))})}else t._clearCache(),t._currentSortCriteria=r,t._currentFilterCriteria=s;return t._fetchByOffset(e)}fetchFirst(e){let t=this,a=null!=e?e[this._SIZE]:-1,r=null!=e?e[this._SORTCRITERIA]:null,i=null!=e?e[this._FILTERCRITERION]:null,s=null!=e?e[this._ATTRIBUTES]:null;t._isSameCriteria(r,i)||(t._currentSortCriteria=r,t._currentFilterCriteria=i,t._clearCache());let n=new t.AsyncIterable(t,new t.AsyncIterator(t,function(){let e=t._iterators.get(n),h=new t.FetchByOffsetParameters(t,e,a,r,i,s);return t.fetchByOffset(h).then(function(a){let r=a.results,i=r.map(function(e){return e[t._DATA]}),s=r.map(function(e){return e[t._METADATA]}),d=0===i.length||a[t._DONE];return t._iterators.set(n,e+s.length),d?Promise.resolve(new t.AsyncIteratorReturnResult(t,new t.FetchListResult(t,h,i,s))):Promise.resolve(new t.AsyncIteratorYieldResult(t,new t.FetchListResult(t,h,i,s)))})},e));return t._iterators.set(n,0),n}getCapability(e){return this.dataProvider.getCapability(e)}getTotalSize(){return Promise.resolve(-1)}isEmpty(){return this.dataProvider.isEmpty()}_isSameCriteria(e,t){if(e){if(!this._currentSortCriteria||e[0].attribute!=this._currentSortCriteria[0].attribute||e[0].direction!=this._currentSortCriteria[0].direction)return!1}else if(this._currentSortCriteria)return!1;if(t){if(!this._currentFilterCriteria||t[0].op!=this._currentFilterCriteria[0].op||t[0].filter!=this._currentFilterCriteria[0].filter)return!1}else if(this._currentFilterCriteria)return!1;return!0}_checkCacheByOffset(e){return-1===e[this._SIZE]&&!0===this._done||this._cache.length>=e[this._OFFSET]+e[this._SIZE]&&-1!==e[this._SIZE]}_getFetchByOffsetResultsFromCache(e){let t=this._cache.slice(e[this._OFFSET],-1===e[this._SIZE]?void 0:e[this._OFFSET]+e[this._SIZE]);return new this.FetchByOffsetResults(this,e,t,!1)}_clearCache(){this._cache=[]}_fetchByOffset(e){let t=this;if(0===t._cache.length){let a=-1===e[t._SIZE]?-1:e[t._OFFSET]+e[t._SIZE],r=new this.FetchByOffsetParameters(t,0,a,e[t._SORTCRITERIA],e[t._FILTERCRITERION],e[t._ATTRIBUTES]);return t._fetchChildrenByOffsetFromDataProvider(r,t.dataProvider,null,e)}let a=t._getLastEntry(),r=a.metadata.key,i=0;!a.metadata.isLeaf&&t._isExpanded(r)||(r=a.metadata.parentKey,i=a.metadata.indexFromParent+1);let s=null===r?t.dataProvider:t.getChildDataProvider(r),n=t._getRemainingSize(e),h=new this.FetchByOffsetParameters(t,i,n,e[t._SORTCRITERIA],e[t._FILTERCRITERION],e[t._ATTRIBUTES]);return t._fetchChildrenByOffsetFromAncestors(h,s,r,e)}_fetchChildrenByOffsetFromAncestors(e,t,a,r){let i=this,s=function(t,a){a.results;if(i._checkCacheByOffset(r)||a[i._DONE]||null===t)return Promise.resolve();let n=i._getItemByKey(t),h=n.metadata.parentKey,d=n.metadata.indexFromParent,l=null===h?i.dataProvider:i.getChildDataProvider(h),o=new i.FetchByOffsetParameters(i,d+1,i._getRemainingSize(r),e[i._SORTCRITERIA],e[i._FILTERCRITERION],e[i._ATTRIBUTES]);return i._fetchChildrenByOffsetFromDataProvider(o,l,h,r).then(s.bind(i,h))};return i._fetchChildrenByOffsetFromDataProvider(e,t,a,r).then(s.bind(i,a)).then(i._getFetchByOffsetResultsFromCache.bind(i,r))}_fetchChildrenByOffsetFromDataProvider(e,t,a,r){let i=this,s=function(t){let n=t.results;if(0===n.length||i._checkCacheByOffset(r))return Promise.resolve();let h=n.shift(),d=i._updateItemMetadata(h,a);if(i._pushItemToCache(d,a),i._isExpanded(d.metadata.key)){let t=i.getChildDataProvider(d.metadata.key);if(null!=t){let a=new i.FetchByOffsetParameters(i,0,i._getRemainingSize(r),e[i._SORTCRITERIA],e[i._FILTERCRITERION],e[i._ATTRIBUTES]);return i._fetchChildrenByOffsetFromDataProvider(a,t,d.metadata.key,r).then(s.bind(i,new i.FetchByOffsetResults(i,e,n,!1)))}}return s(new i.FetchByOffsetResults(i,e,n,!1))};return t.fetchByOffset(e).then(s).then(i._getFetchByOffsetResultsFromCache.bind(i,r))}_sequence(e,t){return e.reduce((e,a)=>e.then(()=>t(a)),Promise.resolve())}_getRemainingSize(e){return-1===e[this._SIZE]?-1:e[this._SIZE]+e[this._OFFSET]-this._cache.length}_getExpandedKeysFromResults(e){let t=this;return e.map(function(e){return e.metadata.key}).filter(function(e){return t._isExpanded(e)})}_isExpanded(e){return this.options[this._EXPANDED].has(e)}setExpanded(t){let a=this,r=a.createOptimizedKeySet(),i=a.createOptimizedKeySet();a._oldExpanded=a.options.expanded,a.options.expanded=t;let s=a._oldExpanded,n=a.options.expanded;if(n.isAddAll()||s.isAddAll()){if(!n.isAddAll()||!s.isAddAll())return a._clearCache(),a.dispatchEvent(new e.DataProviderRefreshEvent),void a.getExpandedObservable().next(a._getExpandedObservableValue(this.options.expanded,Promise.resolve()));var h=n.deletedValues(),d=s.deletedValues();h.forEach(function(e){s.has(e)&&i.add(e)}),d.forEach(function(e){n.has(e)&&r.add(e)})}else{let e=n.values(),t=s.values();e.forEach(function(e){s.has(e)||r.add(e)}),t.forEach(function(e){n.has(e)||i.add(e)})}let l=a._expand(r),o=a._collapse(i),c=new Promise(function(t){l.then(function(r){let i=new a.DataProviderMutationEventDetail(a,r,o,null);a.dispatchEvent(new e.DataProviderMutationEvent(i)),t()})});a.getExpandedObservable().next(a._getExpandedObservableValue(this.options.expanded,c))}getExpandedObservable(){return this._expandedObservable}_isExpandAll(){return this.options[this._EXPANDED].isAddAll()}_pushItemToCache(e,t){let a=this._getLastItemByParentKey(t),r=null==a?this._getItemIndexByKey(t):this._getItemIndexByKey(a.metadata.key)+this._getLocalDescendentCount(a.metadata.key);this._cache.splice(r+1,0,e)}_spliceItemToCache(e,t){this._cache.splice(t+1,0,e)}_updateItemMetadata(e,t,a){let r=0,i=this._getLastItemByParentKey(t),s=null==i?0:i.metadata[this._INDEXFROMPARENT]+1;if(null!=a&&(s=a),null!=t){r=this._getItemByKey(t).metadata.treeDepth+1}return new this.Item(this,new this.FlattenedTreeItemMetadata(this,e.metadata.key,t,s,r,null===this.getChildDataProvider(e.metadata.key)),e.data)}_getItemByKey(e){var t=null;return this._cache.some(function(a){if(a.metadata.key===e)return t=a,!0}),t}_getItemIndexByKey(e){var t=-1;return this._cache.some(function(a,r){if(a.metadata.key===e)return t=r,!0}),t}_getLastEntry(){return this._cache[this._getLastIndex()]}_getEntry(e){return this._cache[e]}_getLastItemByParentKey(e){var t=null;return this._cache.slice().reverse().some(function(a){if(a.metadata.parentKey===e)return t=a,!0}),t}_getLastIndex(){return this._cache.length-1}_getLocalDescendentCount(e){let t=this,a=t._getItemByKey(e),r=0;if(null!=a){let i=t._getItemIndexByKey(e),s=a.metadata.treeDepth,n=t._getLastIndex();for(let e=i+1;e<=n;e++){if(!(t._getEntry(e).metadata.treeDepth>s))return r;r+=1}}return r}_expand(e){let t=[],a=this;return e.forEach(function(e){let r=new a.FetchByOffsetParameters(a,0,-1,a._currentSortCriteria,a._currentFilterCriteria,null),i=a.getChildDataProvider(e);t.push(a._fetchChildrenByOffsetFromDataProvider(r,i,e,r))}),Promise.all(t).then(function(){let t=a.createOptimizedKeySet(),r=a.createOptimizedKeySet(),i=[],s=[],n=[];return e.forEach(function(e){let h=a._getLocalDescendentCount(e);if(h>0){let d=a._getItemIndexByKey(e)+1,l=null;a._cache.slice(d,d+h).forEach(function(e,h){t.add(e.metadata.key),r.add(l),i.push(e.metadata),s.push(e.data),n.push(d+h),l=e.metadata.key,a._incrementIteratorOffset()})}}),new a.DataProviderAddOperationEventDetail(a,t,r,[],i,s,n)})}_collapse(e){let t=this,a=[],r=[],i=[],s=t.createOptimizedKeySet();return e.forEach(function(e){let n=t._getLocalDescendentCount(e);if(n>0){let h=t._getItemIndexByKey(e);t._cache.splice(h+1,n).forEach(function(e,n){s.add(e.metadata.key),a.push(e.metadata),r.push(e.data),i.push(h+n+1),t._decrementIteratorOffset(h+1)})}}),new t.DataProviderOperationEventDetail(t,s,a,r,i)}_decrementIteratorOffset(e){var t=this;t._iterators.forEach(function(a,r){e<a&&t._iterators.set(r,a-1)})}_incrementIteratorOffset(){var e=this;e._iterators.forEach(function(t,a){e._iterators.set(a,t+1)})}createOptimizedKeySet(e){return this.dataProvider.createOptimizedKeySet?this.dataProvider.createOptimizedKeySet(e):new a(e)}createOptimizedKeyMap(e){if(this.dataProvider.createOptimizedKeyMap)return this.dataProvider.createOptimizedKeyMap(e);if(e){let t=new h;return e.forEach(function(e,a){t.set(a,e)}),t}return new h}}
/**
 * @preserve Copyright 2013 jQuery Foundation and other contributors
 * Released under the MIT license.
 * http://jquery.org/license
 */
return e.FlattenedTreeDataProviderView=d,e.FlattenedTreeDataProviderView=d,e.EventTargetMixin.applyMixin(d),d});